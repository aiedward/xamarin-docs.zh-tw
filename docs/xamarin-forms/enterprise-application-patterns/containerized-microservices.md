---
title: 容器化的微服務
description: 本章說明如何使用微服務和容器來建立 agile、可調整且可靠的新式雲端應用程式。
ms.prod: xamarin
ms.assetid: 5872ad92-04e0-4f1a-9691-79d5602f5683
ms.technology: xamarin-forms
author: davidbritch
ms.author: dabritch
ms.date: 08/07/2017
no-loc:
- Xamarin.Forms
- Xamarin.Essentials
ms.openlocfilehash: 30c2f39a299b59022df8d651762df0dd7023e264
ms.sourcegitcommit: 63029dd7ea4edb707a53ea936ddbee684a926204
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/20/2021
ms.locfileid: "98608958"
---
# <a name="containerized-microservices"></a>容器化的微服務

> [!NOTE]
> 此電子書已在2017的春季發行，且自那時起尚未更新。 本書中有很多工具價值，但有些材質已過期。

開發用戶端-伺服器應用程式時，會著重于建立在每一層中使用特定技術的分層式應用程式。 這類應用程式通常稱為整合 *型應用程式* ，並封裝到針對尖峰負載預先調整的硬體上。 這種開發方法的主要缺點是每個階層內各元件之間的緊密結合、個別元件無法輕鬆調整，以及測試成本。 簡單的更新對階層的其餘部分可能會產生未預期的影響，因此應用程式元件的變更需要重新測試並重新部署整個層。

尤其是在雲端存留期內，無法輕鬆地調整個別的元件。 整合型應用程式包含領域特定功能，通常會依功能層來劃分，例如前端、商務邏輯和資料儲存體。 整合型應用程式的方式是將整個應用程式複製到多部電腦，如圖8-1 所示。

![整合型應用程式調整方法](containerized-microservices-images/monolithicapp.png)

**圖 8-1**：整合型應用程式調整方法

## <a name="microservices"></a>微服務

微服務提供不同的方法來開發和部署應用程式，這種方法適用于現代化雲端應用程式的靈活性、規模和可靠性需求。 微服務應用程式會分解成獨立的元件，這些元件會一起運作，以提供應用程式的整體功能。 「微服務」一詞強調應用程式應該是由小到的服務所組成，以反映獨立的考慮，讓每個微服務都能實行單一函式。 此外，每個微服務都有定義完善的合約，讓其他微服務可以與它進行通訊及共用資料。 微服務的典型範例包括購物車、清查處理、購買子系統和付款處理。

相較于一起調整的大型整合型應用程式，微服務可以獨立相應放大。 這表示，需要更多處理能力或網路頻寬才能支援需求的特定功能區域可以調整，而不需要向外擴充應用程式的其他區域。 圖8-2 說明這種方法，在此方法中，微服務會獨立部署並調整規模，以跨電腦建立服務的實例。

![圖顯示兩個應用程式，其圖格代表不同的功能區域，以及六個從兩個應用程式裝載各種功能區域的矩形。](containerized-microservices-images/microservicesapp.png)

**圖 8-2**：微服務應用程式調整方法

微服務向外延展可能幾乎是瞬間的，可讓應用程式適應變更的負載。 例如，應用程式 web 對向功能中的單一微服務，可能是應用程式中需要向外延展以處理額外連入流量的唯一微服務。

應用程式擴充性的傳統模型是讓負載平衡、無狀態層具有共用的外部資料存放區來儲存持續性資料。 可設定狀態的微服務會管理自己的持續性資料，通常會將其儲存在放置它們的伺服器本機上，以避免網路存取和跨服務作業複雜度的額外負荷。 這可讓資料的處理速度最快，並可消除快取系統的需求。 此外，可擴充的可設定狀態微服務通常會在其實例之間分割資料，以管理單一伺服器可支援的資料大小和傳輸輸送量。

微服務也支援獨立更新。 微服務之間的緊密結合可提供快速且可靠的應用程式演進。 其獨立的分散式本質支援輪流更新，其中只有單一微服務的實例子集會在任何指定的時間更新。 因此，如果偵測到問題，您可以回復錯誤的更新，然後再以錯誤的程式碼或設定更新所有實例。 同樣地，微服務通常會使用架構版本設定，以便在套用更新時，用戶端會看到一致的版本，而不論哪個微服務實例正在進行通訊。

因此，微服務應用程式有許多優於整合型應用程式的優點：

- 每個微服務相對較小，而且易於管理和演進。
- 每個微服務都可以獨立于其他服務進行開發和部署。
- 每個微服務都可以獨立相應放大。 例如，目錄服務或購物籃服務可能需要向外擴充，而不是訂購服務。 因此，產生的基礎結構會在相應放大時更有效率地使用資源。
- 每個微服務都會隔離任何問題。 例如，如果服務發生問題，它只會影響該服務。 其他服務可以繼續處理要求。
- 每個微服務都可以使用最新技術。 由於微服務是自主且並存執行，因此可以使用最新的技術和架構，而不是強制使用整合型應用程式可能使用的較舊架構。

不過，以微服務為基礎的解決方案也有潛在的缺點：

- 選擇如何將應用程式分割成微服務可能會很困難，因為每個微服務都必須完全自主、端對端，包括其資料來源的責任。
- 開發人員必須執行服務間的通訊，以增加應用程式的複雜度和延遲。
- 您通常無法在多個微服務之間進行不可部分完成的交易。 因此，商務需求必須採用微服務之間的最終一致性。
- 在生產環境中，部署及管理許多獨立服務的系統遭到入侵時，會有相當的操作複雜性。
- 直接用戶端對微服務通訊可能會讓您難以重構微服務的合約。 例如，將系統分割成服務的時間可能需要變更。 單一服務可能會分割成兩個以上的服務，而兩個服務可能會合並。 當用戶端直接與微服務進行通訊時，此重構工作可能會中斷與用戶端應用程式的相容性。

## <a name="containerization"></a>容器化

容器化是一種軟體發展方法，在此方法中，應用程式及其版本設定的相依性，加上其環境設定抽象化為部署資訊清單檔案，會封裝成容器映射、以一個單位進行測試，並部署到主機作業系統。

容器是隔離、資源控制和可移植的作業環境，可讓應用程式在不觸及其他容器或主機資源的情況下執行。 因此，容器的外觀和行為就像是剛安裝的實體電腦或虛擬機器。

容器與虛擬機器之間有許多相似之處，如圖8-3 所示。

![下圖顯示虛擬機器和容器之間的比較，其中的虛擬機器有三個應用程式，分別在虛擬機器上以虛擬機器和主機 O 為單位，且容器在單一作業系統上有三個裝載于容器引擎的應用程式。](containerized-microservices-images/containersvsvirtualmachines.png)

**圖 8-3**：虛擬機器和容器的比較

容器會執行作業系統、具有檔案系統，並且可透過網路來存取，就像是實體或虛擬機器一樣。 不過，容器所使用的技術和概念與虛擬機器非常不同。 虛擬機器包含應用程式、必要的相依性，以及完整的客體作業系統。 容器包含應用程式及其相依性，但與其他容器共用作業系統，在主機作業系統上以獨立程式的形式執行， (除了在每個容器) 的特殊虛擬機器中執行的 Hyper-v 容器之外。 因此，容器會共用資源，而且通常需要比虛擬機器少的資源。

容器導向開發與部署方法的優點是，它可以排除不一致的環境，以及它們所帶來的問題所引發的大部分問題。 此外，容器可依需求具現化新的容器，以允許快速的應用程式擴充功能。

建立和使用容器的主要概念如下：

- 容器主機：設定為裝載容器的實體或虛擬機器。 容器主機將會執行一或多個容器。
- 容器映射：映射是由多層式檔案系統堆疊在彼此之上的聯集所組成，而且是容器的基礎。 映射沒有狀態，且在部署至不同環境時永遠不會變更。
- 容器：容器是映射的執行時間實例。
- 容器 OS 映像：容器會從映像進行部署。 容器作業系統映射是組成容器之可能許多映射層中的第一個層。 容器作業系統是不可變的，且無法修改。
- 容器存放庫：每次建立容器映射時，映射及其相依性都會儲存在本機儲存機制中。 這些映像可在容器主機上重複使用多次。 容器映射也可以儲存在公用或私用登錄中（例如 [Docker Hub](https://hub.docker.com/)），讓它們可以跨不同的容器主機使用。

企業在實行以微服務為基礎的應用程式時，會逐漸採用容器，而 Docker 已成為大部分軟體平臺和雲端廠商所採用的標準容器。

EShopOnContainers 參考應用程式會使用 Docker 來裝載四個容器化後端微服務，如圖8-4 所示。

![eShopOnContainers 參考應用程式後端微服務](containerized-microservices-images/microservicesarchitecture.png)

**圖 8-4**： eShopOnContainers 參考應用程式後端微服務

參考應用程式中後端服務的架構，會以共同作業微服務和容器的形式分解成多個自主子系統。 每個微服務都提供單一功能區域：身分識別服務、目錄服務、訂購服務和購物籃服務。

每個微服務都有自己的資料庫，讓它能夠與其他微服務完全分離。 必要時，會使用應用層級事件來達成來自不同微服務之資料庫之間的一致性。 如需詳細資訊，請參閱 [微服務之間的通訊](#communication-between-microservices)。

如需參考應用程式的詳細資訊，請參閱 [.Net 微服務：容器化 .Net 應用程式的架構](https://aka.ms/microservicesebook)。

## <a name="communication-between-client-and-microservices"></a>用戶端與微服務之間的通訊

EShopOnContainers 行動裝置應用程式會使用 *直接用戶端對微服務* 通訊，與容器化後端微服務通訊，如圖8-5 所示。

![圖表顯示連接至三個後端微服務的行動裝置上裝載的應用程式，每個都有自己的 Web A P I 容器。](containerized-microservices-images/directclienttomicroservicecommunication.png)

**圖 8-5**：直接用戶端對微服務通訊

透過直接用戶端對微服務通訊，行動應用程式會透過其公用端點直接對每個微服務提出要求，每個微服務都有不同的 TCP 埠。 在生產環境中，端點通常會對應至微服務的負載平衡器，其會將要求分散到可用的實例之間。

> [!TIP]
> 請考慮使用 API 閘道通訊。 當您建立一個大型且複雜的微服務型應用程式時，直接用戶端對微服務通訊可能會有缺點，但它對小型應用程式而言則是不夠的。 當您設計具有數十個微服務的大型微服務型應用程式時，請考慮使用 API 閘道通訊。 如需詳細資訊，請參閱 [.Net 微服務：容器化 .Net 應用程式的架構](https://aka.ms/microservicesebook)。

## <a name="communication-between-microservices"></a>微服務之間的通訊

以微服務為基礎的應用程式是一種分散式系統，可能在多部電腦上執行。 每個服務執行個體通常就是一個處理序。 因此，服務必須根據每個服務的本質，使用處理序間通訊協定（例如 HTTP、TCP、Advanced Message (AMQP) 或二進位通訊協定）進行互動。

微服務對微服務通訊的兩個常見方法是在查詢資料時以 HTTP 為基礎的 REST 通訊，以及在多個微服務之間溝通更新時的輕量非同步通訊。

以非同步訊息為基礎的事件驅動通訊，在跨多個微服務傳播變更時相當重要。 使用這個方法時，微服務會在發生問題時（例如，當它更新商務實體時）發佈事件。 其他微服務訂閱這些事件。 然後，當微服務接收到事件時，它會更新自己的商務實體，這可能會導致更多的事件被發佈。 這項發佈-訂閱功能通常是透過事件匯流排來達成。

事件匯流排允許微服務之間的發佈-訂閱通訊，而不需要明確地察覺元件，如圖8-6 所示。

![發佈-使用事件匯流排訂閱](containerized-microservices-images/eventbus.png)

**圖8-6：** 發佈-使用事件匯流排訂閱

從應用程式的觀點來看，事件匯流排只是透過介面公開的發佈-訂閱通道。 不過，事件匯流排的執行方式可能會有所不同。 例如，事件匯流排的執行可能會使用 RabbitMQ、Azure 服務匯流排或其他服務匯流排，例如 NServiceBus 和 MassTransit。 圖8-7 顯示事件匯流排在 eShopOnContainers 參考應用程式中的使用方式。

![參考應用程式中的非同步事件驅動通訊](containerized-microservices-images/microservicesarchitecturewitheventbus.png)

**圖8-7：** 參考應用程式中的非同步事件驅動通訊

使用 RabbitMQ 所執行的 eShopOnContainers 事件匯流排提供一對多的非同步發佈/訂閱功能。 這表示在發行事件之後，可能會有多個訂閱者接聽相同的事件。 圖8-9 說明此關聯性。

![一對多通訊](containerized-microservices-images/eventdrivencommunication.png)

**圖 8-9**：一對多通訊

這種一對多的通訊方法會使用事件來執行跨越多個服務的商務交易，以確保服務之間的最終一致性。 最終一致的交易是由一系列的分散式步驟所組成。 因此，當使用者設定檔微服務收到 UpdateUser 命令時，它會更新使用者在其資料庫中的詳細資料，並將 UserUpdated 事件發佈至事件匯流排。 購物籃微服務和訂購微服務都已訂閱接收此事件，並在回應中更新其各自資料庫中的購買者資訊。

> [!NOTE]
> 使用 RabbitMQ 所執行的 eShopOnContainers 事件匯流排僅供用來作為概念證明。 若為生產系統，則應考慮替代的事件匯流排實施。

如需事件匯流排執行的相關資訊，請參閱 [.Net 微服務：容器化 .Net 應用程式的架構](https://aka.ms/microservicesebook)。

## <a name="summary"></a>摘要

微服務提供一種應用程式開發和部署的方法，適用于新式雲端應用程式的靈活性、規模和可靠性需求。 微服務的主要優點之一，就是可以獨立相應放大，這表示特定功能區域可進行調整，需要更多處理能力或網路頻寬來支援需求，而不會有不必要地調整應用程式的區域，而不會增加需求。

容器是隔離、資源控制和可移植的作業環境，可讓應用程式在不觸及其他容器或主機資源的情況下執行。 企業在實行以微服務為基礎的應用程式時，會逐漸採用容器，而 Docker 已成為大部分軟體平臺和雲端廠商所採用的標準容器。

## <a name="related-links"></a>相關連結

- [下載電子書 (2Mb PDF) ](https://aka.ms/xamarinpatternsebook)
- [eShopOnContainers (GitHub)  (範例) ](https://github.com/dotnet-architecture/eShopOnContainers)
