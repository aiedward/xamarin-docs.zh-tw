---
title: 建立 Android 服務
description: 本指南將討論「Xamarin Android 服務」，這是可在沒有作用中使用者介面的情況下執行工作的 Android 元件。 服務非常常用於在背景中執行的工作，例如耗費時間的計算、下載檔案、播放音樂等等。 它會說明服務適用的各種不同案例，並示範如何同時執行這些作業，以進行長時間執行的背景工作，以及提供介面來進行遠端程序呼叫。
ms.prod: xamarin
ms.assetid: BA371A59-6F7A-F62A-02FC-28253504ACC9
ms.technology: xamarin-android
author: conceptdev
ms.author: crdun
ms.date: 03/19/2018
ms.openlocfilehash: 7123d7d491bb32a8a506b308cac5ecb6458a1add
ms.sourcegitcommit: 57f815bf0024b1afe9754c0e28054fc0a53ce302
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/06/2019
ms.locfileid: "70754877"
---
# <a name="creating-android-services"></a>建立 Android 服務

_本指南將討論「Xamarin Android 服務」，這是可在沒有作用中使用者介面的情況下執行工作的 Android 元件。服務非常常用於在背景中執行的工作，例如耗費時間的計算、下載檔案、播放音樂等等。它會說明服務適用的各種不同案例，並示範如何同時執行這些作業，以進行長時間執行的背景工作，以及提供介面來進行遠端程序呼叫。_

## <a name="android-services-overview"></a>Android 服務總覽

行動應用程式不像桌面應用程式。 桌上型電腦擁有膨脹佈滿的資源，例如螢幕房地產、記憶體、儲存空間，以及連線電源供應器、行動裝置。 這些條件約束會強制行動應用程式以不同的方式運作。 例如，行動裝置上的小型螢幕通常表示一次只會顯示一個應用程式（亦即活動）。 其他活動會移至背景，並推送到無法執行任何工作的已暫停狀態。 不過，因為 Android 應用程式在背景中並不表示應用程式無法繼續運作。 

Android 應用程式由下列四個主要元件中的至少一個組成：_活動_、_廣播接收器_、_內容提供者_和_服務_。 活動是許多絕佳 Android 應用程式的基石，因為它們提供的 UI 可讓使用者與應用程式互動。 不過，在執行並行或背景工作時，活動不一定是最佳選擇。

在 Android 中背景工作的主要機制是_服務_。 Android 服務是設計用來在沒有使用者介面的情況下執行某些工作的元件。 服務可能會下載檔案、播放音樂，或將篩選套用至影像。 服務也可以用於 Android 應用程式之間的處理序間通訊（_IPC_）。 例如，一個 Android 應用程式可能會使用來自另一個應用程式的音樂播放機服務，或應用程式可能會透過服務向其他應用程式公開資料（例如人員的連絡人資訊）。 

服務及其執行背景工作的能力，對於提供順暢且流暢的使用者介面十分重要。 所有 Android 應用程式都有_主執行緒_（也稱為_UI 執行緒_），活動會在其上執行。 為了讓裝置保持回應，Android 必須能夠以每秒60畫面的速率來更新使用者介面。 如果 Android 應用程式在主執行緒上執行太多工作，則 Android 會捨棄畫面格，而使 UI 變得不變（有時也稱為_janky_）。 這表示在 UI 執行緒上執行的任何工作，都應該在兩個框架之間的時間範圍內完成，大約是16毫秒（每隔60個框架1秒）。 

若要解決此問題，開發人員可以使用活動中的執行緒來執行某些會封鎖 UI 的工作。 不過，這可能會造成問題。 Android 可能會摧毀並重新建立活動的多個實例。 不過，Android 不會自動終結執行緒，這可能會導致記憶體流失。 其中一個主要的範例是當[裝置旋轉](~/android/app-fundamentals/handling-rotation.md) &ndash;時，Android 會嘗試終結活動的實例，然後重新建立一個新的實例：

![當裝置旋轉時，會終結實例1，並建立實例2](images/image-01.png)

這是潛在的記憶體&ndash;流失，活動的第一個實例所建立的執行緒仍在執行中。 如果執行緒具有活動第一個實例的參考，這會使 Android 無法進行垃圾收集物件的工作。 不過，仍會建立活動的第二個實例（接著可能會建立新的執行緒）。 快速連續旋轉裝置數次可能會耗盡所有的 RAM，並強制 Android 終止整個應用程式來回收記憶體。

根據經驗法則，如果要執行的工作應該 outlive 活動，則應該建立服務來執行該工作。 不過，如果工作僅適用于活動的內容，則建立執行緒來執行工作可能會比較適當。 例如，針對剛新增至相片圖庫應用程式的相片建立縮圖，可能會發生在服務中。 不過，執行緒可能更適合用來播放一些音樂，只有當活動在前景時才會聽到。

背景工作可以分成兩個廣泛的分類：

1. **長時間**執行的工作&ndash;這是持續進行的工作，直到明確停止為止。 _長時間_執行工作的範例是串流音樂或必須監視從感應器收集之資料的應用程式。 即使應用程式沒有可見的使用者介面，這些工作也必須執行。
2. **定期**工作（有時稱為「作業」）定期工作是在持續時間（數秒）內相對較短的工作，並依排程執行（也就是一週一天一次，或許是在接下來的60秒）。 &ndash; 其中一個範例是從網際網路下載檔案，或產生影像的縮圖。

Android 服務有四種不同的類型：

* 系結**服務**系結服務是指有一些其他元件（通常是活動）系結的服務。 &ndash; 系結服務所提供的介面，可讓系結元件和服務彼此互動。 一旦不再有用戶端系結至服務，Android 就會關閉服務。 

* **`IntentService`** 是可簡化服務建立和使用`Service`之類別的特殊子類別。 &ndash; _`IntentService`_ `IntentService`是為了處理個別的自發呼叫。 不同于可以同時處理`IntentService`多個呼叫的服務，更像_工作佇列處理器_ &ndash;工作會排入佇列，並`IntentService`在單一背景工作執行緒上一次處理一個作業。 一般而言，`IntentService`不會系結至活動或片段。 

* **已啟動服務**已_啟動的服務_是由其他 Android 元件（例如活動）啟動的服務，並會在背景中持續執行，直到明確告知服務停止為止。 &ndash; 與系結服務不同的是，已啟動的服務沒有任何直接系結到它的用戶端。 基於這個理由，請務必設計已啟動的服務，讓它們可以視需要適當地重新開機。

* **混合式服務**「混合式_服務_」是一種服務，其具有已_啟動服務_和系結服務的特性。 &ndash; 當元件系結至混合式服務，或可能由某個事件啟動時，就可以啟動它。 用戶端元件不一定會系結至混合式服務。 混合式服務會持續執行，直到明確告知停止，或直到沒有其他用戶端系結為止。

要使用哪種類型的服務非常依賴應用程式需求。 根據經驗法則， `IntentService`或系結服務足以應付 Android 應用程式必須執行的大部分工作，因此應該將喜好設定授與這兩種服務類型的其中一種。 `IntentService`是「一次性」工作的理想選擇，例如下載檔案，而系結服務則適用于需要經常與活動/片段互動時。 

雖然大部分的服務都是在背景執行，但還是有一個特殊的子類別，稱為「_前景服務_」。 這是提供較高優先順序的服務（與一般服務相比），可為使用者執行一些工作（例如播放音樂）。 

您也可以在同一部裝置上的自己進程中執行服務，這有時稱為_遠端服務_，或作為_跨進程服務_。 這需要更多的建立工作，但在應用程式需要與其他應用程式共用功能時很有用，但在某些情況下，可以改善應用程式的使用者體驗。 

### <a name="background-execution-limits-in-android-80"></a>Android 8.0 中的背景執行限制

從 Android 8.0 （API 層級26）開始，Android 應用程式不再能夠在背景中自由執行。 在前景時，應用程式可以啟動並執行服務，而不受限制。 當應用程式移至背景時，Android 會授與應用程式一段特定的時間來啟動和使用服務。 經過該時間之後，應用程式就無法再啟動任何服務，而且任何已啟動的服務都將終止。 此時，應用程式不可能執行任何工作。 如果符合下列其中一個條件，Android 會將應用程式視為前景：

* 有一個可見的活動（已啟動或已暫停）。
* 應用程式已啟動前景服務。
* 另一個應用程式會在前景中，並使用應用程式中的元件（在背景中則為）。 例如，如果應用程式 A 位於前景，則系結至應用程式 B 所提供的服務。應用程式 B 也會被視為前景，而 Android 不會在背景中終止。

在某些情況下，即使應用程式在背景中，Android 還是會喚醒應用程式，並將這些限制放寬幾分鐘，讓應用程式能夠執行一些工作：
* 應用程式會收到高優先順序的 Firebase 雲端訊息。
* 應用程式會收到廣播。 
* 應用程式會接收並執行`PendingIntent` ，以回應通知。

現有的 Xamarin 應用程式可能必須變更其執行背景工作的方式，以避免 Android 8.0 上可能發生的任何問題。 以下是 Android 服務的一些實用替代方案：

* **使用 Android 工作排程器或[Firebase 作業發送器](~/android/platform/firebase-job-dispatcher.md)，將工作排程在背景中執行**這兩個程式庫提供一個架構，讓應用程式將背景工作隔離到作業中，這是一個離散的工作單位。 &ndash; 然後，應用程式可以使用作業系統來排程作業，以及有關作業何時可執行檔一些準則。
* **在前景啟動服務**&ndash;前景服務適用于應用程式必須在背景執行某些工作，而且使用者可能需要定期與該工作互動的時機。 前景服務會顯示持續性通知，讓使用者知道應用程式正在執行背景工作，也會提供一種方式來監視或與工作互動。 其中一個範例是播客應用程式，它會向使用者播放播客，或下載播客集，讓您可以在稍後欣賞。 
* **使用高優先順序的 Firebase 雲端訊息（FCM）** &ndash;當 Android 收到應用程式的高優先順序 FCM 時，它會允許該應用程式在短時間內于背景執行服務。 這是讓背景服務在背景中輪詢應用程式的好方法。 
* **延遲應用程式進入前景時的工作**&ndash;如果上述解決方案都不可行，則應用程式必須開發自己的方法，才能在應用程式進入前景時暫停和繼續工作。

## <a name="related-links"></a>相關連結

* [Android Oreo 背景執行限制](https://www.youtube.com/watch?v=Pumf_4yjTMc)
